<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>–£—á—ë—Ç –ª–æ–≥–∏—Å—Ç–∏–∫–∏</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 20px;
			background-color: #f7f9fa;
			color: #333;
		}

		h2 {
			text-align: center;
			margin-bottom: 20px;
		}

		.input-row {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
			margin-bottom: 15px;
		}

		.input-row input {
			padding: 5px;
			width: 160px;
			border: 1px solid #ccc;
			border-radius: 4px;
		}

		.input-row input:focus {
			border-color: #007BFF;
			outline: none;
		}

		button {
			padding: 10px 20px;
			margin-bottom: 10px;
			margin-right: 10px;
			background-color: #007BFF;
			border: none;
			color: white;
			border-radius: 5px;
			cursor: pointer;
		}

		button:hover {
			background-color: #0056b3;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin-bottom: 15px;
		}

		table th,
		table td {
			border: 1px solid #ccc;
			padding: 6px;
			text-align: center;
		}

		table th {
			background-color: #e9ecef;
		}

		tfoot {
			background-color: #f1f3f5;
			font-weight: bold;
		}
	</style>
</head>

<body>
	<!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
	<script>
		if (localStorage.getItem("loggedIn") !== "true") {
			window.location.href = "index.html";
		}
	</script>

	<h2>–£—á—ë—Ç –ø–µ—Ä–µ–≤–æ–∑–æ–∫ –∏ –ø—Ä–∏–±—ã–ª–∏</h2>

	<div class="input-row">
		<input type="date" id="date" />
		<input type="number" id="kmMain" placeholder="–ö–º –æ—Å–Ω–æ–≤–Ω–æ–π" />
		<input type="number" id="kmAdditional" placeholder="–ö–º –¥–æ–ø" />
		<input type="number" id="freightMain" placeholder="–§—Ä–∞—Ö—Ç –æ—Å–Ω." />
		<input type="number" id="freightAdditional" placeholder="–§—Ä–∞—Ö—Ç –¥–æ–ø" />
		<input type="number" id="fuelConsumption" step="0.1" placeholder="–†–∞—Å—Ö–æ–¥ –ª/100–∫–º" />
		<input type="number" id="fuelPrice" step="0.01" placeholder="–¶–µ–Ω–∞ —Ç–æ–ø–ª–∏–≤–∞" />
		<input type="number" id="tollRoads" placeholder="–ü–ª–∞—Ç–Ω—ã–µ –¥–æ—Ä–æ–≥–∏" />
		<input type="number" id="hotel" placeholder="–û—Ç–µ–ª—å" />
		<input type="number" id="otherExpenses" placeholder="–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã" />
	</div>

	<button onclick="addData()">–î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
	<button onclick="exportToExcel()">–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
	<button onclick="clearData()">–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
	<button onclick="logout()">–í—ã–π—Ç–∏</button>

	<table id="logTable">
		<thead>
			<tr>
				<th>–î–∞—Ç–∞</th>
				<th>–ö–º –æ—Å–Ω.</th>
				<th>–ö–º –¥–æ–ø.</th>
				<th>–û–±—â–∏–π –∫–º</th>
				<th>–§—Ä–∞—Ö—Ç –æ—Å–Ω.</th>
				<th>–§—Ä–∞—Ö—Ç –¥–æ–ø.</th>
				<th>–û–±—â–∏–π —Ñ—Ä–∞—Ö—Ç</th>
				<th>–¢–æ–ø–ª–∏–≤–æ (–ª)</th>
				<th>–¶–µ–Ω–∞ —Ç–æ–ø–ª–∏–≤–∞</th>
				<th>–¢–æ–ø–ª–∏–≤–æ ‚Ç¨</th>
				<th>–ü–ª–∞—Ç–Ω—ã–µ</th>
				<th>–û—Ç–µ–ª—å</th>
				<th>–ü—Ä–æ—á–µ–µ</th>
				<th>–†–∞—Å—Ö–æ–¥ –≤—Å–µ–≥–æ</th>
				<th>–ü—Ä–∏–±—ã–ª—å –¥–æ –Ω–∞–ª–æ–≥–∞</th>
				<th>–ù–∞–ª–æ–≥ 9%</th>
				<th>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</th>
			</tr>
		</thead>
		<tbody></tbody>
		<tfoot id="summaryRow"></tfoot>
	</table>

	<script>
		let data = [];

		window.onload = function () {
			const saved = localStorage.getItem("logisticsData");
			if (saved) {
				data = JSON.parse(saved);
				updateTable();
			}
		};

		function saveToLocalStorage() {
			localStorage.setItem("logisticsData", JSON.stringify(data));
		}

		function addData() {
			const date = document.getElementById('date').value;
			if (!date) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É");

			const kmMain = parseFloat(document.getElementById('kmMain').value) || 0;
			const kmAdditional = parseFloat(document.getElementById('kmAdditional').value) || 0;
			const freightMain = parseFloat(document.getElementById('freightMain').value) || 0;
			const freightAdditional = parseFloat(document.getElementById('freightAdditional').value) || 0;
			const fuelConsumption = parseFloat(document.getElementById('fuelConsumption').value) || 0;
			const fuelPrice = parseFloat(document.getElementById('fuelPrice').value) || 0;
			const tollRoads = parseFloat(document.getElementById('tollRoads').value) || 0;
			const hotel = parseFloat(document.getElementById('hotel').value) || 0;
			const otherExpenses = parseFloat(document.getElementById('otherExpenses').value) || 0;

			const totalKm = kmMain + kmAdditional;
			const totalFreight = freightMain + freightAdditional;
			const fuelUsed = (totalKm / 100) * fuelConsumption;
			const fuelCost = fuelUsed * fuelPrice;
			const totalExpenses = tollRoads + hotel + otherExpenses + fuelCost;
			const profitBeforeTax = totalFreight - totalExpenses;
			const tax = profitBeforeTax * 0.09;
			const netProfit = profitBeforeTax - tax;

			const entry = {
				date, kmMain, kmAdditional, totalKm,
				freightMain, freightAdditional, totalFreight,
				fuelUsed, fuelPrice, fuelCost,
				tollRoads, hotel, otherExpenses,
				totalExpenses, profitBeforeTax, tax, netProfit
			};

			data.push(entry);
			sendToSheet(entry); // üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Google –¢–∞–±–ª–∏—Ü—É
			saveToLocalStorage();
			updateTable();
		}

		function updateTable() {
			const tbody = document.querySelector("#logTable tbody");
			tbody.innerHTML = "";
			let sums = {
				kmMain: 0, kmAdditional: 0, totalKm: 0,
				freightMain: 0, freightAdditional: 0, totalFreight: 0,
				fuelUsed: 0, fuelCost: 0,
				tollRoads: 0, hotel: 0, otherExpenses: 0,
				totalExpenses: 0, profitBeforeTax: 0, tax: 0, netProfit: 0
			};

			data.forEach((entry) => {
				const row = document.createElement("tr");
				row.innerHTML = `
          <td>${entry.date}</td>
          <td>${entry.kmMain}</td><td>${entry.kmAdditional}</td><td>${entry.totalKm}</td>
          <td>${entry.freightMain.toFixed(2)}</td><td>${entry.freightAdditional.toFixed(2)}</td><td>${entry.totalFreight.toFixed(2)}</td>
          <td>${entry.fuelUsed.toFixed(2)}</td><td>${entry.fuelPrice.toFixed(2)}</td><td>${entry.fuelCost.toFixed(2)}</td>
          <td>${entry.tollRoads.toFixed(2)}</td><td>${entry.hotel.toFixed(2)}</td><td>${entry.otherExpenses.toFixed(2)}</td>
          <td>${entry.totalExpenses.toFixed(2)}</td>
          <td>${entry.profitBeforeTax.toFixed(2)}</td>
          <td>${entry.tax.toFixed(2)}</td>
          <td>${entry.netProfit.toFixed(2)}</td>
        `;
				tbody.appendChild(row);

				for (let key in sums) {
					sums[key] += entry[key] || 0;
				}
			});

			document.getElementById("summaryRow").innerHTML = `
        <td>–ò–¢–û–ì–û</td>
        <td>${sums.kmMain}</td><td>${sums.kmAdditional}</td><td>${sums.totalKm}</td>
        <td>${sums.freightMain.toFixed(2)}</td><td>${sums.freightAdditional.toFixed(2)}</td><td>${sums.totalFreight.toFixed(2)}</td>
        <td>${sums.fuelUsed.toFixed(2)}</td><td>-</td><td>${sums.fuelCost.toFixed(2)}</td>
        <td>${sums.tollRoads.toFixed(2)}</td><td>${sums.hotel.toFixed(2)}</td><td>${sums.otherExpenses.toFixed(2)}</td>
        <td>${sums.totalExpenses.toFixed(2)}</td>
        <td>${sums.profitBeforeTax.toFixed(2)}</td><td>${sums.tax.toFixed(2)}</td><td>${sums.netProfit.toFixed(2)}</td>
      `;
		}

		function clearData() {
			if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")) {
				localStorage.removeItem("logisticsData");
				data = [];
				updateTable();
			}
		}

		function exportToExcel() {
			const rows = document.querySelectorAll("table tr");
			let csv = [];

			for (let row of rows) {
				const cols = row.querySelectorAll("td, th");
				let csvRow = [];
				for (let col of cols) {
					let text = col.innerText.replace(/"/g, '""');
					csvRow.push(`"${text}"`);
				}
				csv.push(csvRow.join(","));
			}

			const blob = new Blob([csv.join("\n")], { type: "text/csv;charset=utf-8;" });
			const url = URL.createObjectURL(blob);
			const link = document.createElement("a");
			link.href = url;
			link.setAttribute("download", "logistika.csv");
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);
			URL.revokeObjectURL(url);
		}

		function logout() {
			localStorage.removeItem("loggedIn");
			window.location.href = "index.html";
		}

		function sendToSheet(entry) {
			const url = "https://script.google.com/macros/s/AKfycbypAhcwqrJ0HOAp_rRn0HyCn1mII4Na_JEqmsZs359QUS5kOtU_11yUzwmzx0Q-6F89Zg/exec";

			fetch(url, {
				method: "POST",
				mode: "no-cors",
				headers: {
					"Content-Type": "application/json"
				},
				body: JSON.stringify(entry)
			})
			.then(() => console.log("–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Google –¢–∞–±–ª–∏—Ü—É"))
			.catch(err => console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", err));
		}
	</script>
</body>

</html>
